<!DOCTYPE html><html lang="en"><head><title>Cakefile</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="Cakefile"><meta name="groc-project-path" content="Cakefile"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">Cakefile</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">fs      = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
{exec,spawn} = <span class="hljs-built_in">require</span> <span class="hljs-string">'child_process'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>task = invoke = option = -&gt;</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ANSI Terminal Colors.</p></div></div><div class="code"><div class="wrapper">bold = red = green = reset = <span class="hljs-string">''</span>
<span class="hljs-keyword">unless</span> process.env.NODE_DISABLE_COLORS
  bold  = <span class="hljs-string">'\x1B[0;1m'</span>
  red   = <span class="hljs-string">'\x1B[0;31m'</span>
  green = <span class="hljs-string">'\x1B[0;32m'</span>
  reset = <span class="hljs-string">'\x1B[0m'</span>
<span class="hljs-function">
<span class="hljs-title">log</span> = <span class="hljs-params">(error, stdout, stderr)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log stdout, stderr</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(error.message) if error?</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function">
<span class="hljs-title">clean</span> = <span class="hljs-params">(root)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    files = fs.readdirSync root
  <span class="hljs-keyword">catch</span> e
    log <span class="hljs-literal">null</span>, <span class="hljs-string">''</span>, e.message
    <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span>  files.length &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files
      path = <span class="hljs-string">"<span class="hljs-subst">#{root}</span>/<span class="hljs-subst">#{file}</span>"</span>
      stat = fs.lstatSync path
      <span class="hljs-keyword">if</span> stat.isFile() <span class="hljs-keyword">or</span> stat.isSymbolicLink()
        fs.unlinkSync path
      <span class="hljs-keyword">else</span>
        clean path
  fs.rmdirSync root

option <span class="hljs-string">'-v'</span>, <span class="hljs-string">'--verbose [LEVEL]'</span>, <span class="hljs-string">'set groc\'s verbosity level during documentation generation. [0=silent,1,2,3]'</span>
<span class="hljs-function">
<span class="hljs-title">groc</span> = <span class="hljs-params">(options = {})</span> -&gt;</span>
  pkg = <span class="hljs-built_in">require</span> <span class="hljs-string">'./package.json'</span>
  args = [<span class="hljs-string">'--title'</span>]
  <span class="hljs-keyword">if</span> options.title?
    args.push options.title
  <span class="hljs-keyword">else</span>
    args.push <span class="hljs-string">"<span class="hljs-subst">#{pkg.name}</span> [ version <span class="hljs-subst">#{pkg.version}</span> ]"</span>
  <span class="hljs-keyword">if</span> options.languages? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (<span class="hljs-number">1</span> &gt; options.languages)
    args.push <span class="hljs-string">'--languages'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; options.languages
      options[<span class="hljs-string">'languages'</span>] = (process.cwd() + <span class="hljs-string">'/misc/groc_languages'</span>)
    args.push options.languages
  <span class="hljs-keyword">if</span> options.github? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (<span class="hljs-number">1</span> &gt; options.github)
    args.push <span class="hljs-string">'--github'</span>
  <span class="hljs-keyword">if</span> options.verbose? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (<span class="hljs-number">1</span> &gt; options.verbose)
    args.push <span class="hljs-string">'--verbose'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-number">1</span> &lt; options.verbose
      args.push <span class="hljs-string">'--very-verbose'</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">"running groc <span class="hljs-subst">#{args.join <span class="hljs-string">' '</span>}</span>"</span>
  <span class="hljs-keyword">else</span>
    args.push <span class="hljs-string">'--silent'</span>
  spawn <span class="hljs-string">'groc'</span>, args, <span class="hljs-attribute">stdio</span>: <span class="hljs-string">'inherit'</span>, <span class="hljs-attribute">cwd</span>: <span class="hljs-string">'.'</span>

rebuild = <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">render</span> = <span class="hljs-params">(template, data)</span> -&gt;</span>
  template.replace <span class="hljs-regexp">/\{\{\s*([\w\.]*)\s*\}\}/g</span>, <span class="hljs-function"><span class="hljs-params">(match, path)</span> -&gt;</span>
    path  = path.split <span class="hljs-string">"."</span>
    value = data[path.shift()]
    value = value[key] <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> path
    value ? <span class="hljs-string">""</span>

task <span class="hljs-string">'all'</span>, <span class="hljs-string">'invokes “clean”, “build”, “test” and “doc:source” in given order'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'all'</span>
  rebuild = <span class="hljs-literal">true</span>
  invoke <span class="hljs-string">'clean'</span>
  invoke <span class="hljs-string">'build'</span>
  invoke <span class="hljs-string">'test'</span>
  invoke <span class="hljs-string">'doc:source'</span>

task <span class="hljs-string">'build'</span>, <span class="hljs-string">'invokes “build:once” and “build:parser” in given order'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'build'</span>
  rebuild = <span class="hljs-literal">true</span>
  invoke <span class="hljs-string">'build:once'</span>
  invoke <span class="hljs-string">'build:parser'</span>

task <span class="hljs-string">'clean'</span>, <span class="hljs-string">'cleans “doc/” and “lib/” folders'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'clean'</span>
  clean <span class="hljs-string">'doc'</span>
  fs.mkdirSync <span class="hljs-string">'doc'</span>
  clean <span class="hljs-string">'lib'</span>
  fs.mkdirSync <span class="hljs-string">'lib'</span>

task <span class="hljs-string">'build:watch'</span>, <span class="hljs-string">'compile Coffeescript in “src/” to Javascript in “lib/” continiously'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'build:watch'</span>
  spawn <span class="hljs-string">'coffee'</span>, <span class="hljs-string">'-o ../lib/ -mcw .'</span>.split(<span class="hljs-string">' '</span>), <span class="hljs-attribute">stdio</span>: <span class="hljs-string">'inherit'</span>, <span class="hljs-attribute">cwd</span>: <span class="hljs-string">'src'</span>

task <span class="hljs-string">'build:once'</span>, <span class="hljs-string">'compile Coffeescript in “src/” to Javascript in “lib/” once'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'build:once'</span>
  spawn <span class="hljs-string">'coffee'</span>, <span class="hljs-string">'-o ../lib/ -mc .'</span>.split(<span class="hljs-string">' '</span>), <span class="hljs-attribute">stdio</span>: <span class="hljs-string">'inherit'</span>, <span class="hljs-attribute">cwd</span>: <span class="hljs-string">'src'</span>

task <span class="hljs-string">'build:parser'</span>, <span class="hljs-string">'rebuild the goatee-script parser; run at least “build:once” first!'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'build:parser'</span>

  js  = <span class="hljs-string">'./lib/Parser.js'</span>
  cs  = <span class="hljs-string">'./src/Grammar.coffee'</span>
  map = js.replace(<span class="hljs-regexp">/\.js$/</span>, <span class="hljs-string">'.map'</span>)

  mapStat = fs.existsSync map
  jsStat  = <span class="hljs-keyword">if</span> fs.existsSync js <span class="hljs-keyword">then</span> fs.statSync js <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
  csStat  = <span class="hljs-keyword">if</span> fs.existsSync cs <span class="hljs-keyword">then</span> fs.statSync cs <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>

  <span class="hljs-keyword">if</span> (rebuild <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> mapStat <span class="hljs-keyword">isnt</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span> jsStat <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span>
      jsStat.mtime &lt; csStat.mtime <span class="hljs-keyword">or</span> jsStat.size &lt; csStat.size)
    <span class="hljs-built_in">require</span> <span class="hljs-string">'coffee-script/register'</span>
    <span class="hljs-built_in">require</span> <span class="hljs-string">'jison'</span> <span class="hljs-comment"># TODO This seems to be important, have to figure out why !</span>
    {Grammar} = <span class="hljs-built_in">require</span>(cs.replace(<span class="hljs-regexp">/\.coffee$/</span>,<span class="hljs-string">''</span>))
    grammar   = <span class="hljs-keyword">new</span> Grammar
    fs.writeFileSync js, grammar.create()
  <span class="hljs-keyword">try</span> fs.unlinkSync map <span class="hljs-keyword">if</span> rebuild <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> mapStat <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>

task <span class="hljs-string">'test'</span>, <span class="hljs-string">'run “build” task and tests in “tests/” afterwards'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'test'</span>
  invoke <span class="hljs-string">'build'</span> <span class="hljs-keyword">if</span> rebuild <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>
  spawn <span class="hljs-string">'npm'</span>, [<span class="hljs-string">'test'</span>], <span class="hljs-attribute">stdio</span>: <span class="hljs-string">'inherit'</span>, <span class="hljs-attribute">cwd</span>: <span class="hljs-string">'.'</span>


option <span class="hljs-string">'-t'</span>, <span class="hljs-string">'--title [TITLE]'</span>, <span class="hljs-string">'override  groc\'s title argument for `cake doc:*`'</span>
option <span class="hljs-string">'-l'</span>, <span class="hljs-string">'--languages [FILE]'</span>, <span class="hljs-string">'override groc\'s language-definition file-path for `cake doc:*`'</span>

task <span class="hljs-string">'doc'</span>, <span class="hljs-string">'invokes “doc:source” and “doc:github” in given order'</span>, <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'doc'</span>
  invoke <span class="hljs-string">'doc:source'</span>
  invoke <span class="hljs-string">'doc:github'</span>

task <span class="hljs-string">'doc:source'</span>, <span class="hljs-string">'rebuild the internal documentation'</span>, <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'doc:source'</span>
  clean <span class="hljs-string">'doc'</span>
  options[<span class="hljs-string">'github'</span>] = <span class="hljs-number">0</span>
  groc options

task <span class="hljs-string">'doc:github'</span>, <span class="hljs-string">'rebuild the github documentation'</span>, <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'doc:github'</span>
  options[<span class="hljs-string">'github'</span>] = <span class="hljs-number">1</span>
  groc options

option <span class="hljs-string">'-p'</span>, <span class="hljs-string">'--prefix [DIR]'</span>, <span class="hljs-string">'set the installation prefix for `cake install`'</span>

task <span class="hljs-string">'install'</span>, <span class="hljs-string">'install GoateeScript into /usr/local (or --prefix)'</span>, <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'install'</span>
  base = options.prefix <span class="hljs-keyword">or</span> <span class="hljs-string">'/usr/local'</span>
  lib  = <span class="hljs-string">"<span class="hljs-subst">#{base}</span>/lib/goatee-script"</span>
  bin  = <span class="hljs-string">"<span class="hljs-subst">#{base}</span>/bin"</span>
  node = <span class="hljs-string">"~/.node_libraries/goatee-script"</span>
  <span class="hljs-built_in">console</span>.log   <span class="hljs-string">"Installing GoateeScript to <span class="hljs-subst">#{lib}</span>"</span>
  <span class="hljs-built_in">console</span>.log   <span class="hljs-string">"Linking to <span class="hljs-subst">#{node}</span>"</span>
  <span class="hljs-built_in">console</span>.log   <span class="hljs-string">"Linking 'goatee' to <span class="hljs-subst">#{bin}</span>/goatee-script"</span>
  exec([
    <span class="hljs-string">"mkdir -p <span class="hljs-subst">#{lib}</span> <span class="hljs-subst">#{bin}</span>"</span>
    <span class="hljs-string">"cp -rf bin lib LICENSE README.md package.json src <span class="hljs-subst">#{lib}</span>"</span>
    <span class="hljs-string">"ln -sfn <span class="hljs-subst">#{lib}</span>/bin/goatee-script <span class="hljs-subst">#{bin}</span>/goatee-script"</span>
    <span class="hljs-string">"mkdir -p ~/.node_libraries"</span>
    <span class="hljs-string">"ln -sfn <span class="hljs-subst">#{lib}</span>/lib/goatee-script <span class="hljs-subst">#{node}</span>"</span>
  ].join(<span class="hljs-string">' &amp;&amp; '</span>), <span class="hljs-function"><span class="hljs-params">(err, stdout, stderr)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> err <span class="hljs-keyword">then</span> <span class="hljs-built_in">console</span>.log stderr.trim() <span class="hljs-keyword">else</span> log <span class="hljs-string">'done'</span>, green
  )</div></div></div></div></body></html>